<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
<!-- VANTA + THREE.js -->
<div id="vanta-background" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-1;"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>
<script>
  function loadVantaBG() {
    if (window.vantaBG && typeof window.vantaBG.destroy === "function") {
      window.vantaBG.destroy();
      window.vantaBG = null;
    }
    window.vantaBG = VANTA.FOG({
      el: "#vanta-background",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            highlightColor: 0x112D4E,
            midtoneColor: 0xe6e6e6,
            lowlightColor: 0xebebeb,
            baseColor: 0xffffff
          });
  }
  document.addEventListener("turbo:load", loadVantaBG);
  document.addEventListener("DOMContentLoaded", loadVantaBG);
</script>

<%= stylesheet_link_tag "dashboard", "data-turbo-track": "reload" %>

<script type="application/json" id="tasks-data">
  <%= @tasks.group_by_day(:created_at, range: 4.days.ago.beginning_of_day..Time.now).count.to_json.html_safe %>
</script>
<%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>

<div class="dashboard-page font-main">
  <div class="container">
    <div class="top-section d-flex flex-wrap">

      <!-- Statistics Panel -->
      <div class="statistics-card card me-4 flex-grow-1 ">
        <div class="statistics-box">
          <h2 class="text-center">Statistics</h2>
          <div class="graph-placeholder" style="max-width:660px; margin:auto; width: 600px; height: 400px;">
            <canvas id="statsChart" width="600" height="400" style="width: 600px; height: 400px;"></canvas>
          </div>
          <%= link_to "üìä Advanced statistics", statistics_path, class: "button-or mt-4 d-block mx-auto" %>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column d-flex flex-column" data-controller="task-modal">
        <!-- New Task Panel -->
        <div class="cardform">
          <h2 class="text-center mb-3">New task</h2>
          <form action="<%= tasks_path %>" method="post" autocomplete="off">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="mb-3">
              <label for="task_name" class="form-label">Task name:</label>
              <input type="text" id="task_name" name="task[name]" class="form-control" placeholder="Enter task name" required>
            </div>
            <div class="mb-3 d-flex align-items-center">
              <label for="quick-task-time" class="form-label me-2 mb-0">Time (min):</label>
              <input type="number" id="quick-task-time" name="task[time]" class="form-control" style="width: 90px;" min="1" placeholder="25" required>
            </div>
            <div class="d-flex justify-content-center">
              <button type="submit" class="button-or">
                <i class="fa fa-plus me-2"></i>Create task
              </button>
              <!-- Modal button -->
              <button type="button" class="button-or ml-3" data-bs-toggle="modal" data-bs-target="#exampleModalCenter">
                <i class="fa fa-ellipsis-h"></i>
              </button>
            </div>
          </form>
        </div>
        <!-- Task Modal Form -->
        <div>
          <%= form_with(model: @task, url: tasks_path, local: true) do |form| %>
            <div class="modal fade" id="exampleModalCenter" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Create a Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <%= hidden_field_tag "task[name]", "", id: "modal_task_name" %>
                    <%= hidden_field_tag "task[time]", "", id: "modal_task_time" %>
                    <div class="step step-1" data-task-modal-target="step">
                      <h5>Number of Sub-Tasks:</h5>
                      <%= form.select :subtask_count, options_for_select([1,2,3,4,5], 1), {}, { class: "form-select", data: { task_modal_target: "subtaskCountSelect", action: "change->task-modal#updateSubtaskCount" } } %>
                    </div>
                    <%= form.hidden_field :subtask_count, data: { task_modal_target: "hiddenSubtaskCount" } %>
                    <div class="step step-2 d-none" data-task-modal-target="step">
                      <h5>Sub-task Names:</h5>
                      <div data-task-modal-target="subtaskInputs"></div>
                    </div>
                    <div class="step step-3 d-none" data-task-modal-target="step">
                      <h5>Time Distribution:</h5>
                      <div data-task-modal-target="timeDistribution"></div>
                      <fieldset class="mt-3">
                        <div>
                          <%= form.radio_button :distribution, "even", checked: true, id: "distribution_even" %>
                          <%= form.label :distribution_even, "Evenly" %>
                        </div>
                        <div>
                          <%= form.radio_button :distribution, "incremental", id: "distribution_incremental" %>
                          <%= form.label :distribution_incremental, "Incremental" %>
                        </div>
                        <div>
                          <%= form.radio_button :distribution, "decremental", id: "distribution_decremental" %>
                          <%= form.label :distribution_decremental, "Decremental" %>
                        </div>
                        <div>
                          <%= form.radio_button :distribution, "random", id: "distribution_random" %>
                          <%= form.label :distribution_random, "Random" %>
                        </div>
                      </fieldset>
                    </div>
                    <div class="step step-4 d-none" data-task-modal-target="step">
                      <h5>Setup Task:</h5>
                      <p><strong>Task Summary:</strong></p>
                      <%= form.text_area :description, name: 'task[description]', class: "form-control mb-3", rows: 4, placeholder: "Task summary..." %>
                      <%= form.submit "Create Task", class: "btn btn-success" %>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-task-modal-target="prevBtn" data-action="click->task-modal#prev">Back</button>
                    <button type="button" class="btn btn-primary" data-task-modal-target="nextBtn" data-action="click->task-modal#next">Next</button>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
        <!-- Recent Tasks Panel -->
        <div class="recent-tasks card">
          <h3 class="text-center mb-3">Recent Tasks</h3>
          <div class="recent-tasks-inner">
            <ul class="task-list">
              <% @tasks.order(created_at: :desc).limit(10).each do |task| %>
                <li><%= task.name %></li>
              <% end %>
            </ul>
          </div>
        </div>
    </div>
  </div>
</div>

<footer class="footer-bar">
  <div class="footer-content">
    <a href="https://twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
    <a href="https://github.com" target="_blank" aria-label="GitHub"><i class="fab fa-github"></i></a>
    <a href="https://linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
  </div>
</footer>

<script>
function loadStatsChart() {
  const canvas = document.getElementById("statsChart");
  if (!canvas) return;

  if (window.statsChartInstance) {
    try { window.statsChartInstance.destroy(); } catch(e) {}
    window.statsChartInstance = null;
  }

  const dataElement = document.getElementById("tasks-data");
  if (!dataElement) return;

  const chartData = JSON.parse(dataElement.textContent);
  const labels = Object.keys(chartData);
  const values = Object.values(chartData);

  // D√©grad√© bleu-mauve
  const ctx = canvas.getContext("2d");
  let gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, "#5f68c3"); // Bleu-mauve
  gradient.addColorStop(0.5, "#a18cd1"); // Mauve
  gradient.addColorStop(1, "#4fc3f7"); // Bleu ciel

  window.statsChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "T√¢ches cr√©√©es",
        data: values,
        backgroundColor: gradient,
        borderColor: "#5f68c3",
        borderWidth: 1.5,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          mode: "index",
          intersect: false,
          animation: false
        },
        zoom: {
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "x"
          },
          pan: { enabled: true, mode: "x" }
        }
      },
      hover: { mode: "nearest", intersect: true, animationDuration: 0 },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: "#dbe2ef" },
          ticks: { color: "#112D4E" }
        },
        x: {
          grid: { display: false },
          ticks: { color: "#112D4E" }
        }
      }
    }
  });
}
document.addEventListener("turbo:load", loadStatsChart);
document.addEventListener("DOMContentLoaded", loadStatsChart);
</script>
